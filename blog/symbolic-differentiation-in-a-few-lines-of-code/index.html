<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Research software for infectious disease epidemiology at Imperial College">


  

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://reside-ic.github.io/img/logo.png" >



<title>Symbolic differentiation in a few lines of code - Reside-IC</title>
<meta property="og:title" content="Symbolic differentiation in a few lines of code - Reside-IC">

<meta property="description" content="We are working on automatic differentiation of odin models, which requires support for differentiating expressions symbolically, in order to write new equations that can be used to numerically propagate derivatives of a model.
R already has support for doing this via the D function:
D(quote(2 * x^2 * log(sqrt(x))), &#34;x&#34;) ## 2 * (2 * x) * log(sqrt(x)) &#43; 2 * x^2 * (0.5 * x^-0.5/sqrt(x)) and the Deriv package provides an extensible interface.">
<meta property="og:description" content="We are working on automatic differentiation of odin models, which requires support for differentiating expressions symbolically, in order to write new equations that can be used to numerically propagate derivatives of a model.
R already has support for doing this via the D function:
D(quote(2 * x^2 * log(sqrt(x))), &#34;x&#34;) ## 2 * (2 * x) * log(sqrt(x)) &#43; 2 * x^2 * (0.5 * x^-0.5/sqrt(x)) and the Deriv package provides an extensible interface.">



<title>


     Reside-IC - Symbolic differentiation in a few lines of code 

</title>
<link rel="canonical" href="https://reside-ic.github.io/blog/symbolic-differentiation-in-a-few-lines-of-code/">


<style media="screen">
  @font-face {
  font-family: 'Nexa Bold';
  src: url('https://reside-ic.github.io/fonts/Nexa Bold.otf');
}

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed,
figure, figcaption, footer, header, hgroup,
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure,
footer, header, hgroup, menu, nav, section, div.column {
  display: block;
}
body {
  line-height: 1;
}
ol, ul {
  list-style: none;
}
blockquote, q {
  quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
  content: '';
  content: none;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}

*,
*:before,
*:after {
  box-sizing: border-box;
}
a,
a:visited,
a:focus,
a:active {
  text-decoration: none;
}
html {
  height: 100%;
  font-size: 16px;
}
body {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
  width: 100%;
  min-height: 100%;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  color: #111111;
  line-height: 1.6;
  text-rendering: optimizeLegibility !important;
}
.icon {
  text-rendering: geometricPrecision !important;
}
section {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
div.column {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
.container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  width: 100%;
}
div.header .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.header .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.header .container .logo {
  
  max-width: 100px;
  
  margin-left: -2em;
}
div.header .name {
  padding-top: 20px;
  font-size: 28px;
  font-family: 'Nexa Bold', 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  
  text-transform: uppercase;
  
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
}
div.header nav {
  margin-bottom: 16px;
}
div.header nav ul {
  list-style: none;
  text-align: center;
  display: -webkit-inline-flex;
  display: -moz-inline-flex;
  display: -ms-inline-flexbox;
  display: -ms-inline-flex;
  display: inline-flex;
}
div.header nav ul li {
  margin-left: 6px;
  margin-right: 6px;
}
div.header nav ul li:first-child {
  margin-left: 0;
}
div.header nav ul li:last-child {
  margin-right: 0;
}
div.header nav ul a {
  color: #555555;
  font-weight: 400;
  font-size: 14px;
  text-transform: uppercase;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.header nav ul a:hover {
  color: #111111;
}
div.footer .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  flex-direction: column-reverse;
  width: 100%;
  text-align: center;
}
div.footer .container a {
  font-size: 14px;
  margin-left: 6px;
  margin-right: 6px;
  opacity: 0.6;
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.footer .container a:first-child {
  margin-left: 0;
}
div.footer .container a:last-child {
  margin-right: 0;
}
div.footer .container a:hover {
  opacity: 0.8;
}
div.footer .container a .icon {
  width: 16px;
  height: 16px;
}
div.footer .container .copyright {
  flex-grow: 0.5;
  text-align: start;
}
div.footer .container .icons {
  flex-grow: 0.5;
  text-align: end;
}
div.main .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
}
div.main .content {
  color: #111111;
  font-size: 16px;
}
div.main .content .title-container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: space-between;
  -moz-justify-content: space-between;
  -ms-justify-content: space-between;
  justify-content: space-between;
}
div.main .content .posts {
  
  
}
div.main .content .page-heading {
  font-size: 20px;
  font-weight: 700;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  text-transform: uppercase;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  margin-bottom: 16px;
}
div.main .content .front-matter .page-heading {
  margin-bottom: 0;
}
div.main .content .front-matter .meta {
  font-size: 14px;
  color: #666666;
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  margin-bottom: 32px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
  display: none;
}
div.main .content .front-matter .middot:before {
  font-size: 6px;
  margin: 0 6px;
  vertical-align: middle;
  content: "•";
}
div.main .content .front-matter .tags ul {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .content .front-matter .tags ul li {
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.main .content .front-matter .tags ul li:hover {
  opacity: 0.7;
}
div.main .content .front-matter .tags ul li a {
  color: #666666;
}
div.main .container.f04 {
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.main .container.f04 .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .container.f04 .content .num {
  margin: 30px 0px 30px 0;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  font-size: 50px;
}
div.main .container.f04 .content .detail {
  margin-bottom: 40px;
}
div.main .container .content .groupby {
  margin-top: 1em;
  padding-left: 0.5em;
}
div.main .container .content .post-item {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  display: list-item;
  list-style: disc inside;
}
div.main .container .content .post-item .meta {
  font-size: 14px;
  color: #666666;
  display: none;
  min-width: 100px;
}
div.main .container .content .see-more {
  font-style: italic;
  float: right;
  font-size: 0.9em;
  margin-top: 2em;
  color: #313537;
}
div.main .container .content .see-more:hover {
  color: #666;
}
section {
  padding: 0 16px;
}
div.column {
  padding: 0 16px;
}
div.header {
  padding-top: 10px;
}
div.header-home {
  padding-top: 36px;
}
div.main {
  padding-top: 32px;
}
div.main .container .content .post-item .meta {
    display: block;
}
div.main .container .content .post-item {
    display: flex;
    list-style: none;
}
a {
  color: #428bca;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
a:hover {
  color: #2a6496;
}
img {
  max-width: 100%;
}
div.main .content {
    width: 100%;
}
div.main .content .markdown {
  font-size: 1.1em;
  line-height: 1.75em;
  color: #313537;
  font-family: serif;
  font-weight: 300;
}
div.main .content .markdown h1,
div.main .content .markdown h2,
div.main .content .markdown h3,
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 22px;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  font-weight: 700;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  text-transform: none;
  margin-top: 1.75rem;
}
div.main .content .markdown h1 {
  font-size: 1.75rem;
  margin-bottom: 2rem;
}
div.main .content .markdown h2 {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
}
div.main .content .markdown h3 {
  font-size: 1em;
  margin-bottom: 1rem;
}
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 1rem;
  margin-bottom: 1rem;
  letter-spacing: none;
}
div.main .content .markdown code,
div.main .content .markdown pre {
  font-family: 'Menlo', monospace;
  font-size: 0.98rem;
  background-color: #f7f7f7;
}
div.main .content .markdown code {
  /* enclosed by single backtick (`) */
  padding: .15em .5em;
  border-radius: 2px;
}
div.main .content .markdown pre {
  /* Hugo specific: consider using the 'highlight' shortcode */
  display: block;
  margin-top: 1rem;
  margin-bottom: 2rem;
  padding: 1rem;
  line-height: 1.5em;
  white-space: pre;
  word-break: break-all;
  word-wrap: break-word;
}
div.main .content .markdown pre code {
  /* enclosed by 4 backticks (````) */
  padding: 0;
  font-size: 0.9rem;
}
div.main .content .markdown a code {
  color: #428bca !important;
}
div.main .content .markdown a code:hover {
  text-decoration: underline;
}
div.main .content .markdown p {
  
  text-align: justify;
  
  margin-top: 0;
  margin-bottom: 1em;
}
div.main .content .markdown ul,
div.main .content .markdown ol,
div.main .content .markdown dl {
  margin-top: 1rem;
  margin-bottom: 2rem;
}
div.main .content .markdown dt {
  font-weight: bold;
}
div.main .content .markdown dd {
  margin-bottom: .5rem;
}
div.main .content .markdown ul {
  list-style-type: disc;
  list-style-position: outside;
  margin-bottom: 1.25rem;
}
div.main .content .markdown ol {
  list-style-type: decimal;
  margin-bottom: 1.25rem;
}
div.main .content .markdown li {
  margin-left: 2em;
}
div.main .content .markdown em {
  font-style: italic;
}
div.main .content .markdown strong {
  font-weight: 700;
}
div.main .content .markdown hr {
  position: relative;
  margin: 1.75rem 0;
  border: 0;
  border-top: 1px solid #808080;
  border-top: 1px solid #999999;
}
div.main .content .markdown abbr {
  font-size: 0.85rem;
  font-weight: bold;
  color: #666666;
  text-transform: uppercase;
}
div.main .content .markdown abbr[title] {
  cursor: help;
  border-bottom: 1px dotted #808080;
}
div.main .content .markdown blockquote {
  padding: .5rem 1rem;
  margin: .8rem 0;
  color: #7a7a7a;
  border-left: .25rem solid #e5e5e5;
}
div.main .content .markdown blockquote p:last-child {
  margin-bottom: 0;
}
div.main .content .markdown figure {
  width: 100%;
  background: #fff;
  margin-bottom: 1em;
}
div.main .content .markdown figure img {
  width: 100%;
  height: auto;
  max-width: 100%;
  display: block;
  position: static;
  margin: auto;
}
div.main .content .markdown table {
  margin-bottom: 1rem;
  width: 100%;
  border: 1px solid #e5e5e5;
  border-collapse: collapse;
}
div.main .content .markdown td,
div.main .content .markdown th {
  padding: .25rem .5rem;
  border: 1px solid #e5e5e5;
}
div.main .content .markdown tbody tr:nth-child(odd) td,
div.main .content .markdown tbody tr:nth-child(odd) th {
  background-color: #f7f7f7;
}
div.main .content .markdown .footnotes ol {
  list-style-type: decimal;
  margin-left: 16px;
}
div.main .content .markdown .footnotes li {
  list-style-type: unset;
}
div.main .content .markdown .footnote-ref {
  font-size: 0.7em;
}
div.main .content .navigation {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  padding: 2em;
}
div.main .content .navigation div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  margin-top: 1em;
}
div.main .content .navigation .icon {
  width: 16px;
  height: 16px;
}
div.main .content .navigation a {
  width: 250px;
  margin: 0 1em;
  text-align: center;
  font-style: italic;
  color: #313537;
}
div.main .content .share, div.main .content .share div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  justify-content: center;
}
div.main .content .share {
  background-color: rgba(152, 152, 152, 0.07);
  padding: 1em 0;
}
div.main .content .share a {
  margin: 0 6px;
}
kbd {
  padding: 0.1em 0.6em;
  border: 1px solid #ccc;
  font-size: 11px;
  font-family: Arial,Helvetica,sans-serif;
  background-color: #f7f7f7;
  color: #333;
  -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  display: inline-block;
  margin: 0 0.1em;
  text-shadow: 0 1px 0 #fff;
  line-height: 1.4;
  white-space: nowrap;
}

/* Fonts */


.wf-raleway-n4-active body, 
.wf-raleway-n4-active div.header nav ul a,
.wf-raleway-n7-active div.main .content .page-heading,
.wf-raleway-n2-active div.main .container.f04 .content .num,
.wf-raleway-n7-active div.main .content .markdown h1,
.wf-raleway-n7-active div.main .content .markdown h2,
.wf-raleway-n7-active div.main .content .markdown h3,
.wf-raleway-n7-active div.main .content .markdown h4,
.wf-raleway-n7-active div.main .content .markdown h5,
.wf-raleway-n7-active div.main .content .markdown h6 {
      font-family: 'Raleway';
}

.wf-merriweather-n3-active div.main .content .markdown {
      font-family: 'Merriweather';
}

.wf-ubuntu-mono-n4-active div.main .content .markdown code,
.wf-ubuntu-mono-n4-active div.main .content .markdown pre {
      font-family: 'Ubuntu Mono';
}


</style>
<style media="(min-width: 600px)">
  body {
-webkit-justify-content: center;
-moz-justify-content: center;
-ms-justify-content: center;
justify-content: center;
}
.non-narrow.zero-top-spacing {
padding-top: 0 !important;
}
section {
padding: 0 16px;
margin-left: 100px;
margin-right: 100px;

max-width: 750px;

}
div.column {
padding: 0 16px;

max-width: 750px;

}
div.header {
background-color: transparent;
}
div.header .container {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.header .container .logo {
margin: 0;
}
div.header-home .container .logo {
max-width: 216px;
margin-left: 24px;
}
div.header-home .name-home {
padding-top: 30px;
font-size: 40px;
}
div.header-home nav ul a {
font-size: 18px;
}
div.header .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.header .name {
color: #333333;
}
div.header nav {
font-size: 14px;
margin-bottom: 0;
}
div.header nav ul {
text-align: left;
}
div.header nav ul a {
color: #666666;
}
div.header nav ul a:hover {
color: #333333;
}
div.footer {
background-color: transparent;
}
div.footer .container {
flex-direction: row;
}
div.footer .container a {
margin-left: 3px;
margin-right: 3px;
color: #666666;
}
div.footer .container a:hover {
color: #333333;
}
div.footer .container a .icon {
font-size: 18px;
}
div.footer .container a .icon.larger {
font-size: 20px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
display: initial;
}
div.main .container.f04 {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.main .container.f04 .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.main .container.f04 .content .num {
margin: 0 0 10px 0;
font-size: 32px;
}
div.main .container.f04 .content .detail {
margin-bottom: 30px;
}
.container {
padding: 0 30px;
}
div.header {
padding-top: 60px;
padding-bottom: 60px;
}
div.footer {
padding-top: 60px;
padding-bottom: 60px;
}
div.main {
padding-top: 0;
}
div.main .content {
  
  font-size: 16px;
  
}
div.main .container .content .post-item {
display: flex;
list-style: none;
padding-left: 1.5em;
}
div.main .container .content .post-item .meta {
display: block;
}
div.main .content .markdown blockquote {
padding-right: 5rem;
padding-left: 1.25rem;
}
div.main .content .navigation {
-webkit-flex-direction: row;
-moz-flex-direction: row;
-ms-flex-direction: row;
flex-direction: row;
}
div.main .content .navigation div {
margin-top: 0em;
}

</style>
<style media="(min-width: 769px)">
  div.main .content .markdown figure {
width: 110%;
margin-left: -4%;
}
div.main .content .markdown img {
max-width: 110%;
width: 110%;
margin-left: -4%;
}
div.main .content .markdown pre {
width: 110%;
margin-left: -4%;
}

</style>

<style type="text/css" media="screen">
  .column {
    max-width: 900px !important;
}

.team {
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    justify-content: center;
}

.person {
    padding-left: 5px;
    padding-right: 5px;
    width: 269px;
    text-align: center;
}

.person .name {
    font-weight: bold;
}

.person img {
    width: 150px !important;
    -webkit-border-radius: 150px !important;
    border-radius: 150px !important;
    margin: 0 !important;
    height: 150px !important;
    object-fit: cover;
}

.person p {
    text-align: center !important;
    font-size: 0.875em;
}

.text-muted {
    color: #7b888b;
}

div.main .content .markdown pre {
    background-color: #f7f7f7 !important;
}

</style>

<noscript>
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,700,700i" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700" rel="stylesheet">
</noscript>


  <style type="text/css" media="screen">
    .hljs{display:block;background:white;padding:0.5em;color:#333333;overflow-x:auto}.hljs-comment,.hljs-meta{color:#969896}.hljs-string,.hljs-variable,.hljs-template-variable,.hljs-strong,.hljs-emphasis,.hljs-quote{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-literal,.hljs-symbol,.hljs-bullet,.hljs-attribute{color:#0086b3}.hljs-section,.hljs-name{color:#63a35c}.hljs-tag{color:#333333}.hljs-title,.hljs-attr,.hljs-selector-id,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo{color:#795da3}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}
  </style>



  <style type="text/css" media="screen">
    .progressive{overflow:hidden;position:relative;background:#efefef}.progressive__img{width:100%;height:100%;position:absolute;-webkit-transform:translateZ(0);transform:translateZ(0)}.progressive--not-loaded{filter:blur(30px);-webkit-filter:blur(30px)}.progressive--is-loaded{filter:blur(20px);-webkit-filter:blur(20px);-webkit-animation:sharpen .5s both;animation:sharpen .5s both}@-webkit-keyframes sharpen{from{filter:blur(20px);-webkit-filter:blur(20px)}to{filter:blur(0);-webkit-filter:blur(0)}}@keyframes sharpen{from{filter:blur(20px);-webkit-filter:blur(20px)}to{filter:blur(0);-webkit-filter:blur(0)}}
  </style>



  <style type="text/css" media="screen">
    /*!
 * Social Share Kit v1.0.7 (http://socialsharekit.com)
 * Copyright 2015 Social Share Kit / Kaspars Sprogis.
 * Licensed under Creative Commons Attribution-NonCommercial 3.0 license:
 * https://github.com/darklow/social-share-kit/blob/master/LICENSE
 * ---
 */@font-face{font-family:'social-share-kit';src:url('https://reside-ic.github.io/fonts/social-share-kit.eot');src:url('https://reside-ic.github.io/fonts/social-share-kit.eot?#iefix') format('embedded-opentype'),url('https://reside-ic.github.io/fonts/social-share-kit.woff') format('woff'),url('https://reside-ic.github.io/fonts/social-share-kit.ttf') format('truetype'),url('https://reside-ic.github.io/fonts/social-share-kit.svg#social-share-kit') format('svg');font-weight:normal;font-style:normal}.ssk:before{display:inline-block;font-family:"social-share-kit" !important;font-style:normal !important;font-weight:normal !important;font-variant:normal !important;text-transform:none !important;speak:none;line-height:1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.ssk-facebook:before{content:"a";text-indent:4px;margin-right:-4px}.ssk-twitter:before{content:"b"}.ssk-google-plus:before{content:"v"}.ssk-google-plus-old:before{content:"c"}.ssk-email:before{content:"d";top:-1px;position:relative}.ssk-pinterest:before{content:"e"}.ssk-tumblr:before{content:"f"}.ssk-linkedin:before{content:"g"}.ssk-github:before{content:"h"}.ssk-vk:before{content:"i"}.ssk-instagram:before{content:"j"}.ssk-amazon:before{content:"k"}.ssk-skype:before{content:"s"}.ssk-youtube:before{content:"x"}.ssk-vimeo:before{content:"u"}.ssk-ebay:before{content:"p"}.ssk-apple:before{content:"l"}.ssk-behance:before{content:"q"}.ssk-dribble:before{content:"n"}.ssk-android:before{content:"o"}.ssk-whatsapp:before{content:"m"}.ssk-reddit:before{content:"r"}.ssk-reddit2:before{content:"t"}.ssk-link:before{content:"w"}.ssk{background-color:#757575;color:white;display:inline-block;font-size:22px;line-height:1px;margin-right:2px;margin-bottom:2px;padding:7px;text-align:center;text-decoration:none;transition:background-color .1s;-webkit-transition:background-color .1s;-moz-transition:background-color .1s;-ms-transition:background-color .1s;-o-transition:background-color .1s}.ssk:before,.ssk .glyphicon,.ssk .fa{position:relative;font-size:22px;top:0;vertical-align:middle}.ssk.ssk-xs,.ssk-xs>.ssk{padding:4px}.ssk.ssk-xs:before,.ssk-xs>.ssk:before,.ssk.ssk-xs .glyphicon,.ssk-xs>.ssk .glyphicon,.ssk.ssk-xs .fa,.ssk-xs>.ssk .fa{font-size:15px}.ssk.ssk-sm,.ssk-sm>.ssk{padding:5px}.ssk.ssk-sm:before,.ssk-sm>.ssk:before,.ssk.ssk-sm .glyphicon,.ssk-sm>.ssk .glyphicon,.ssk.ssk-sm .fa,.ssk-sm>.ssk .fa{font-size:20px}.ssk.ssk-lg,.ssk-lg>.ssk{padding:9px}.ssk.ssk-lg:before,.ssk-lg>.ssk:before,.ssk.ssk-lg .glyphicon,.ssk-lg>.ssk .glyphicon,.ssk.ssk-lg .fa,.ssk-lg>.ssk .fa{font-size:28px}.ssk:last-child{margin-right:0}.ssk:hover{background-color:#424242}.ssk:hover,.ssk:focus{color:#fff;text-decoration:none}.ssk.ssk-round,.ssk-round .ssk{border-radius:50%}.ssk.ssk-round:before,.ssk-round .ssk:before{text-indent:0;margin-right:0}.ssk.ssk-rounded,.ssk-rounded .ssk{border-radius:15%}.ssk.ssk-icon{color:#757575;padding:2px;font-size:24px}.ssk.ssk-icon,.ssk.ssk-icon:hover{background-color:transparent}.ssk.ssk-icon:hover{color:#424242}.ssk.ssk-icon.ssk-xs,.ssk-xs>.ssk.ssk-icon{font-size:16px}.ssk.ssk-icon.ssk-sm,.ssk-sm>.ssk.ssk-icon{font-size:20px}.ssk.ssk-icon.ssk-lg,.ssk-lg>.ssk.ssk-icon{font-size:28px}.ssk.ssk-text{overflow:hidden;font-size:17px;line-height:normal;padding-right:10px}.ssk.ssk-text:before,.ssk.ssk-text .glyphicon,.ssk.ssk-text .fa{margin:-7px 10px -7px -7px;padding:7px;background-color:rgba(0,0,0,0.15);vertical-align:bottom;text-indent:0}.ssk-block .ssk.ssk-text{display:block;margin-right:0;text-align:left}.ssk.ssk-text.ssk-xs,.ssk-xs>.ssk.ssk-text{font-size:12px;padding-right:6px}.ssk.ssk-text.ssk-xs:before,.ssk-xs>.ssk.ssk-text:before,.ssk.ssk-text.ssk-xs .glyphicon,.ssk-xs>.ssk.ssk-text .glyphicon,.ssk.ssk-text.ssk-xs .fa,.ssk-xs>.ssk.ssk-text .fa{margin:-4px 6px -4px -4px;padding:4px}.ssk.ssk-text.ssk-sm,.ssk-sm>.ssk.ssk-text{font-size:16px;padding-right:7px}.ssk.ssk-text.ssk-sm:before,.ssk-sm>.ssk.ssk-text:before,.ssk.ssk-text.ssk-sm .glyphicon,.ssk-sm>.ssk.ssk-text .glyphicon,.ssk.ssk-text.ssk-sm .fa,.ssk-sm>.ssk.ssk-text .fa{margin:-5px 7px -5px -5px;padding:5px}.ssk.ssk-text.ssk-lg,.ssk-lg>.ssk.ssk-text{font-size:22px;padding-right:13px}.ssk.ssk-text.ssk-lg:before,.ssk-lg>.ssk.ssk-text:before,.ssk.ssk-text.ssk-lg .glyphicon,.ssk-lg>.ssk.ssk-text .glyphicon,.ssk.ssk-text.ssk-lg .fa,.ssk-lg>.ssk.ssk-text .fa{margin:-9px 13px -9px -9px;padding:9px}.ssk-group,.ssk-sticky{font-size:0}.ssk-sticky{top:0;position:fixed;z-index:2000}.ssk-sticky .ssk{transition:padding .1s ease-out;-webkit-transition:padding .1s ease-out;-moz-transition:padding .1s ease-out;-ms-transition:padding .1s ease-out;-o-transition:padding .1s ease-out;margin:0}@media (min-width:768px){.ssk-sticky.ssk-left .ssk,.ssk-sticky.ssk-right .ssk{display:block;clear:both}.ssk-sticky.ssk-left.ssk-center,.ssk-sticky.ssk-right.ssk-center{top:50%;transform:translateY(-50%);-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);-o-transform:translateY(-50%)}.ssk-sticky.ssk-left{left:0}.ssk-sticky.ssk-left .ssk{float:left}.ssk-sticky.ssk-left .ssk:hover{padding-left:15px}.ssk-sticky.ssk-right{right:0}.ssk-sticky.ssk-right .ssk{float:right}.ssk-sticky.ssk-right .ssk:hover{padding-right:15px}}.ssk-sticky.ssk-bottom{font-size:0;top:auto;bottom:0}.ssk-sticky.ssk-bottom.ssk-center{left:50%;right:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-moz-transform:translateX(-50%);-ms-transform:translateX(-50%);-o-transform:translateX(-50%)}.ssk-sticky.ssk-bottom .ssk{vertical-align:bottom}.ssk-sticky.ssk-bottom .ssk:hover{padding-bottom:15px}.ssk-sticky.ssk-round.ssk-xs .ssk:hover{padding:8px}.ssk-sticky.ssk-round.ssk-sm .ssk:hover{padding:9px}.ssk-sticky.ssk-round .ssk:hover{padding:11px}.ssk-sticky.ssk-round.ssk-lg .ssk:hover{padding:13px}@media (max-width:767px){.ssk-sticky{left:0;right:0;bottom:0;top:auto;width:100%;display:flex !important;flex-direction:row;flex-wrap:nowrap}.ssk-sticky.ssk-sticky-hide-xs{display:none !important}.ssk-sticky .ssk{flex:1;width:auto}.ssk-sticky .ssk .ssk-num{display:none}}.ssk-count{padding-top:20px}.ssk-count .ssk{position:relative}.ssk-count .ssk-num{border-radius:4px;color:#8f8f8f;background-color:rgba(50,50,50,0.03);display:block;font-size:12px;left:0;line-height:20px;position:absolute;right:0;text-align:center;top:-20px}@media (min-width:768px){.ssk-count.ssk-sticky{padding-top:0}.ssk-count.ssk-sticky.ssk-left .ssk-num,.ssk-count.ssk-sticky.ssk-right .ssk-num{top:20%;background-color:transparent}.ssk-count.ssk-sticky.ssk-left .ssk-num{left:100%;margin-left:5px}.ssk-count.ssk-sticky.ssk-right .ssk-num{right:115%;margin-left:-100%;text-align:right}}.ssk-facebook{background-color:#3B5998}.ssk-grayscale>.ssk-facebook{background-color:#757575}.ssk-facebook:hover{background-color:#2d4373}.ssk-facebook:hover{background-color:#2d4373}.ssk-grayscale>.ssk-facebook:hover{background-color:#3B5998}.ssk-facebook.ssk-icon{color:#3B5998}.ssk-facebook.ssk-icon:hover{color:#2d4373}.ssk-facebook.ssk-icon:before{text-indent:0;margin-right:0}.ssk-twitter{background-color:#1DA1F2}.ssk-grayscale>.ssk-twitter{background-color:#757575}.ssk-twitter:hover{background-color:#0c85d0}.ssk-twitter:hover{background-color:#0c85d0}.ssk-grayscale>.ssk-twitter:hover{background-color:#1DA1F2}.ssk-twitter.ssk-icon{color:#1DA1F2}.ssk-twitter.ssk-icon:hover{color:#0c85d0}.ssk-google-plus{background-color:#EA4335}.ssk-grayscale>.ssk-google-plus{background-color:#757575}.ssk-google-plus:hover{background-color:#d62516}.ssk-google-plus:hover{background-color:#d62516}.ssk-grayscale>.ssk-google-plus:hover{background-color:#EA4335}.ssk-google-plus.ssk-icon{color:#EA4335}.ssk-google-plus.ssk-icon:hover{color:#d62516}.ssk-pinterest{background-color:#BD081C}.ssk-grayscale>.ssk-pinterest{background-color:#757575}.ssk-pinterest:hover{background-color:#8c0615}.ssk-pinterest:hover{background-color:#8c0615}.ssk-grayscale>.ssk-pinterest:hover{background-color:#BD081C}.ssk-pinterest.ssk-icon{color:#BD081C}.ssk-pinterest.ssk-icon:hover{color:#8c0615}.ssk-tumblr{background-color:#395773}.ssk-grayscale>.ssk-tumblr{background-color:#757575}.ssk-tumblr:hover{background-color:#283d51}.ssk-tumblr:hover{background-color:#283d51}.ssk-grayscale>.ssk-tumblr:hover{background-color:#395773}.ssk-tumblr.ssk-icon{color:#395773}.ssk-tumblr.ssk-icon:hover{color:#283d51}.ssk-email{background-color:#757575}.ssk-grayscale>.ssk-email{background-color:#757575}.ssk-email:hover{background-color:#5b5b5b}.ssk-email:hover{background-color:#5b5b5b}.ssk-grayscale>.ssk-email:hover{background-color:#757575}.ssk-grayscale>.ssk-email:hover{background-color:#5b5b5b}.ssk-email.ssk-icon{color:#757575}.ssk-email.ssk-icon:hover{color:#5b5b5b}.ssk-vk{background-color:#54769a}.ssk-grayscale>.ssk-vk{background-color:#757575}.ssk-vk:hover{background-color:#425d79}.ssk-vk:hover{background-color:#425d79}.ssk-grayscale>.ssk-vk:hover{background-color:#54769a}.ssk-vk.ssk-icon{color:#54769a}.ssk-vk.ssk-icon:hover{color:#425d79}.ssk-linkedin{background-color:#1c87bd}.ssk-grayscale>.ssk-linkedin{background-color:#757575}.ssk-linkedin:hover{background-color:#156791}.ssk-linkedin:hover{background-color:#156791}.ssk-grayscale>.ssk-linkedin:hover{background-color:#1c87bd}.ssk-linkedin.ssk-icon{color:#1c87bd}.ssk-linkedin.ssk-icon:hover{color:#156791}.ssk-whatsapp{background-color:#34AF23}.ssk-grayscale>.ssk-whatsapp{background-color:#757575}.ssk-whatsapp:hover{background-color:#27851a}.ssk-whatsapp:hover{background-color:#27851a}.ssk-grayscale>.ssk-whatsapp:hover{background-color:#34AF23}.ssk-whatsapp.ssk-icon{color:#34AF23}.ssk-whatsapp.ssk-icon:hover{color:#27851a}.ssk-reddit{background-color:#5f99cf}.ssk-grayscale>.ssk-reddit{background-color:#757575}.ssk-reddit:hover{background-color:#3a80c1}.ssk-reddit:hover{background-color:#3a80c1}.ssk-grayscale>.ssk-reddit:hover{background-color:#5f99cf}.ssk-reddit.ssk-icon{color:#5f99cf}.ssk-reddit.ssk-icon:hover{color:#3a80c1}.ssk-reddit2{background-color:#5f99cf}.ssk-grayscale>.ssk-reddit2{background-color:#757575}.ssk-reddit2:hover{background-color:#3a80c1}.ssk-reddit2:hover{background-color:#3a80c1}.ssk-grayscale>.ssk-reddit2:hover{background-color:#5f99cf}.ssk-reddit2.ssk-icon{color:#5f99cf}.ssk-reddit2.ssk-icon:hover{color:#3a80c1}.ssk-turquoise{background-color:#1abc9c}.ssk-turquoise:hover{background-color:#148f77}.ssk-emerald{background-color:#2ecc71}.ssk-emerald:hover{background-color:#25a25a}.ssk-peter-river{background-color:#3498db}.ssk-peter-river:hover{background-color:#217dbb}.ssk-belize-hole{background-color:#2980b9}.ssk-belize-hole:hover{background-color:#20638f}.ssk-amethyst{background-color:#9b59b6}.ssk-amethyst:hover{background-color:#804399}.ssk-wisteria{background-color:#8e44ad}.ssk-wisteria:hover{background-color:#703688}.ssk-wet-asphalt{background-color:#34495e}.ssk-wet-asphalt:hover{background-color:#222f3d}.ssk-midnight-blue{background-color:#2c3e50}.ssk-midnight-blue:hover{background-color:#1a242f}.ssk-green-sea{background-color:#16a085}.ssk-green-sea:hover{background-color:#107360}.ssk-nephritis{background-color:#27ae60}.ssk-nephritis:hover{background-color:#1e8449}.ssk-sunflower{background-color:#f1c40f}.ssk-sunflower:hover{background-color:#c29d0b}.ssk-orange{background-color:#f39c12}.ssk-orange:hover{background-color:#c87f0a}.ssk-carrot{background-color:#e67e22}.ssk-carrot:hover{background-color:#bf6516}.ssk-pumpkin{background-color:#d35400}.ssk-pumpkin:hover{background-color:#a04000}.ssk-alizarin{background-color:#e74c3c}.ssk-alizarin:hover{background-color:#d62c1a}.ssk-pomegranate{background-color:#c0392b}.ssk-pomegranate:hover{background-color:#962d22}.ssk-clouds{background-color:#cfd9db}.ssk-clouds:hover{background-color:#b1c2c6}.ssk-concrete{background-color:#95a5a6}.ssk-concrete:hover{background-color:#798d8f}.ssk-silver{background-color:#bdc3c7}.ssk-silver:hover{background-color:#a1aab0}.ssk-asbestos{background-color:#7f8c8d}.ssk-asbestos:hover{background-color:#667273}.ssk-dark-gray{background-color:#555}.ssk-dark-gray:hover{background-color:#3b3b3b}.ssk-black{background-color:#333}.ssk-black:hover{background-color:#1a1a1a}
  </style>







<link rel="shortcut icon"

    href="https://reside-ic.github.io/img/logo.png"

>


<style>
  kbd {font-size: inherit !important;}
  .tag-list {
    display: flex;
  }
</style>

</head>


<body>


<div class="header column">

    <div class="container">
        
        <a href="https://reside-ic.github.io/"><img class="logo" src="https://reside-ic.github.io/img/logo.png" alt="logo"></a>
        
        <div class="content">
            <a href="https://reside-ic.github.io/"><div class="name"><h1>Reside-IC</h1></div></a>
            <nav>
                <ul>
                    
                            <li><a href="https://reside-ic.github.io/blog/">Blog</a></li>
                    
                    
                        
                            
                            <li><a href="https://reside-ic.github.io/articles">articles</a></li>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <li><a href="https://reside-ic.github.io/projects">projects</a></li>
                            
                        
                    
                    
                        
                            <li><a href="https://reside-ic.github.io/about/">About</a></li>
                        
                    
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</div>







<div class="main post non-narrow zero-top-spacing column">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    
    Symbolic differentiation in a few lines of code
    

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Mon Jun 26 2023 00:00:00 UTC">Jun 26, 2023</div>
                    
                    
                    <div class="author middot" title="Rich FitzJohn">Rich FitzJohn</div>
                    
                    
                    
                    <div class="reading-time middot">10 minute read</div>
                    
                    <div class="middot">
                        Tags:
                    </div>
                    <ul class="tag-list">
                        
                        <li class="middot"><a href="https://reside-ic.github.io/tags/r">R</a> </li>
                        
                    </ul>
                    <div class="tags">
                        <ul>
                            
                            
                        </ul>
                    </div>
                </div>
            </div>
            <div class="markdown">
                
    
    <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>We are working on <a href="https://en.wikipedia.org/wiki/Automatic_differentiation">automatic
differentiation</a>
of <a href="https://mrc-ide.github.io/odin/">odin</a> models, which requires
support for differentiating expressions symbolically, in order to write
new equations that can be used to numerically propagate derivatives of a
model.</p>
<p>R already has support for doing this via the <code>D</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">D</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> x^2 <span style="color:#f92672">*</span> <span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">sqrt</span>(x))), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## 2 * (2 * x) * log(sqrt(x)) + 2 * x^2 * (0.5 * x^-0.5/sqrt(x))
</code></pre>
<p>and the <a href="https://cran.r-project.org/package=Deriv"><code>Deriv</code></a> package
provides an extensible interface. However, <code>odin</code> has peculiar syntax
with arrays and we’re interested in trying to differentiate through
stochastic functions, so a bespoke solution felt useful.</p>
<p>Symbolic differentiation turns out to be surprisingly easy, and quite
elegant, to implement; this post shows the general idea.</p>
<p>To start, consider differentiating the expression <code>x^2 + x^3</code> with
respect to <code>x</code>. Recall the mechanical rules of differentiation from
school that we can write this as <code>d/dx x^2 + d/dx x^3</code> and then that we
differentiate functions of the form <code>x^n</code> as <code>n x^(n - 1)</code> – this is the
primary insight we need: that the process is recursive as we break down
every operation into smaller chunks and keep on differentiating interior
expressions with respect to <code>x</code> until there’s nothing left.</p>
<p>The simplest possible differentiation rules concern numbers; <code>d/dx n</code>
for any number <code>n</code> is zero (that is, the gradient of <code>n</code> with respect to
<code>x</code> is zero). Similarly, for any symbol (say <code>a</code> but not <code>a + b</code>)
<em>except</em> <code>x</code> the derivative is also zero. And the derivative of <code>x</code> with
respect to <code>x</code> is one. With this, we have the edge case for a recursive
function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>differentiate <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is.recursive</span>(expr)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">identical</span>(expr, <span style="color:#a6e22e">as.symbol</span>(name))) <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">stop</span>(<span style="color:#e6db74">&#34;not yet implemented&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>which we can apply like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(x), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## [1] 1
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## [1] 0
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## [1] 0
</code></pre>
<p>Interesting expressions are not supported yet:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(x <span style="color:#f92672">+</span> x <span style="color:#f92672">*</span> x), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## Error in differentiate(quote(x + x * x), &quot;x&quot;): not yet implemented
</code></pre>
<p>To implement the case where we have compound expressions
(<code>is.recursive(expr)</code> returning <code>TRUE</code>), consider the way we can
represent these expressions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>expr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">quote</span>(x <span style="color:#f92672">+</span> x <span style="color:#f92672">*</span> x)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as.list</span>(expr)
</span></span></code></pre></div><pre><code>## [[1]]
## `+`
## 
## [[2]]
## x
## 
## [[3]]
## x * x
</code></pre>
<p>Every call can be represented this way - the first element is the
function being called and the remaining elements are its arguments. This
structure is recursive:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">as.list</span>(expr[[3]])
</span></span></code></pre></div><pre><code>## [[1]]
## `*`
## 
## [[2]]
## x
## 
## [[3]]
## x
</code></pre>
<p>To apply our differentiation rules we need to describe how to handle
each function (here, <code>+</code> and <code>*</code>) and put together the results,
descending into the subexpressions with <code>differentiate()</code> again until we
get our edge cases.</p>
<p>The rule for differentiating sums is very straightforward, as noted
above: we take the sum of the derivatives!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_plus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#a6e22e">differentiate</span>(expr[[2]], name), <span style="color:#a6e22e">differentiate</span>(expr[[3]], name))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>call()</code> function constructs expression arguments (so
<code>call(&quot;+&quot;, quote(x), 1)</code> returns <code>x + 1</code>) and here we are descending
into each expression with <code>differentiate()</code>. We then rewrite
<code>differentiate()</code> to call <code>d_plus()</code> when required:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>differentiate <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is.recursive</span>(expr)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">identical</span>(expr, <span style="color:#a6e22e">as.symbol</span>(name))) <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    fn <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.character</span>(expr[[1]])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(fn,
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#34;+&#34;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_plus</span>(expr, name),
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">stop</span>(<span style="color:#e6db74">&#34;not yet implemented&#34;</span>))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With this we can differentiate a sum of any depth:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(x <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## 1 + 0
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(x <span style="color:#f92672">+</span> y <span style="color:#f92672">+</span> x), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## 1 + 0 + 1
</code></pre>
<p>We can then proceed, writing out rules for different functions as we
need them. For example, the product rule:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_product <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">&lt;-</span> expr[[2]]
</span></span><span style="display:flex;"><span>  b <span style="color:#f92672">&lt;-</span> expr[[3]]
</span></span><span style="display:flex;"><span>  da <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(a, name)
</span></span><span style="display:flex;"><span>  db <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(b, name)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, da, b), <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, a, db))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>or the quotient rule</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_quotient <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">&lt;-</span> expr[[2]]
</span></span><span style="display:flex;"><span>  b <span style="color:#f92672">&lt;-</span> expr[[3]]
</span></span><span style="display:flex;"><span>  da <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(a, name)
</span></span><span style="display:flex;"><span>  db <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(b, name)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## da / b - a * db / (b * b)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;/&#34;</span>, da, b), <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, a, db), <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, b, b)))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For subtraction, we need to distinguish between unary minus (e.g., <code>-a</code>)
and subtraction (e.g., <code>a - b</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_minus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">length</span>(expr) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#a6e22e">differentiate</span>(expr[[2]], name))
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#a6e22e">differentiate</span>(expr[[2]], name), <span style="color:#a6e22e">differentiate</span>(expr[[3]], name))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It turns out that <code>(</code> is a function too, and also needs a rule, but it
is very simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_parenthesis <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;(&#34;</span>, <span style="color:#a6e22e">differentiate</span>(expr[[2]], name))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can put all these rules into a list:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>rules <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">list</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;+&#34;</span> <span style="color:#f92672">=</span> d_plus,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">=</span> d_minus,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#f92672">=</span> d_product,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">=</span> d_quotient,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;(&#34;</span> <span style="color:#f92672">=</span> d_parenthesis)
</span></span></code></pre></div><p>and rewrite our <code>differentiate()</code> implementation again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>differentiate <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is.recursive</span>(expr)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">identical</span>(expr, <span style="color:#a6e22e">as.symbol</span>(name))) <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    fn <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.character</span>(expr[[1]])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(fn <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">names</span>(rules))) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stop</span>(<span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;Differentiation of &#39;%s&#39; not yet implemented&#34;</span>, fn))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    rules[[fn]<span style="color:#a6e22e">]</span>(expr, name)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and with this we can differentiate all sorts of things:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> x <span style="color:#f92672">/</span> (x <span style="color:#f92672">*</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## (-0 * x + -2 * 1)/(x * x - 3 * x) - -2 * x * (1 * x + x * 1 - 
##     (0 * x + 3 * 1))/((x * x - 3 * x) * (x * x - 3 * x))
</code></pre>
<p>This is fine, except that the generated expressions are fairly ugly,
with lots of obviously redundant expressions (e.g., <code>-0 * x</code> which is
obviously <code>0</code> and <code>+ -2 * 1</code> which is just <code>- 2</code>). However, the
expressions agree with those from <code>D</code> once evaluated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">eval</span>(<span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> x <span style="color:#f92672">/</span> (x <span style="color:#f92672">*</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>), <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#66d9ef">pi</span>))
</span></span></code></pre></div><pre><code>## [1] 99.75819
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">eval</span>(<span style="color:#a6e22e">D</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> x <span style="color:#f92672">/</span> (x <span style="color:#f92672">*</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>), <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#66d9ef">pi</span>))
</span></span></code></pre></div><pre><code>## [1] 99.75819
</code></pre>
<h2 id="extending-the-implementation-by-adding-more-rules">Extending the implementation by adding more rules</h2>
<p>We could extend this easily now by adding more rules, and the
implementation will even tell us what we need to add. So if we try and
evaluate</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## Error in differentiate(quote(exp(2 * x)), &quot;x&quot;): Differentiation of 'exp' not yet implemented
</code></pre>
<p>we get told to we need to implement the rule for <code>exp</code> which is simply:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_exp <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#a6e22e">differentiate</span>(expr[[2]], name), expr)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(that is, <code>d/dx exp(f(x))</code> is <code>f'(x) exp(f(x)))</code>. We add this to our set
of rules:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>rules<span style="color:#f92672">$</span>exp <span style="color:#f92672">&lt;-</span> d_exp
</span></span></code></pre></div><p>and now we can differentiate this new expression:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## (0 * x + 2 * 1) * exp(2 * x)
</code></pre>
<h2 id="improving-the-implementation-by-writing-sensible-expressions">Improving the implementation by writing sensible expressions</h2>
<p>Simplifying the expressions turns out to be much more work than the
differentiation. The trick that we use is to avoid using <code>call()</code>
directly to build expressions and create a simplifying expression
builder that applies some simple rules to avoid building overly
complicated expressions. This does not simplify everything, but cuts out
the most egregious bits of noise.</p>
<p>This is probably not important for the efficiency of generated code
(we’re going to send this to an optimising compiler via some C++ code
eventually) but it does make the resulting expressions easier to think
about.</p>
<p>Consider replacing <code>call(&quot;+&quot;, a, b)</code> with something that will avoid
creating silly expressions. If given numeric arguments for <code>a</code> and <code>b</code>
we should sum them, and if either of <code>a</code> or <code>b</code> is zero we should return
the other argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_plus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a, b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_plus</span>(b, a)
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;+&#34;</span>, a, b)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The pattern here is that only the last branch gives up and actually
builds an expression with <code>call()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
</span></span></code></pre></div><pre><code>## [1] 7
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><pre><code>## a
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><pre><code>## 1 + a
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">quote</span>(b))
</span></span></code></pre></div><pre><code>## b
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">quote</span>(b))
</span></span></code></pre></div><pre><code>## 1 + b
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_plus</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#a6e22e">quote</span>(b))
</span></span></code></pre></div><pre><code>## a + b
</code></pre>
<p>We can do similar things with multiplication:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_product <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a, b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">*</span> b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_product</span>(b, a)
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;*&#34;</span>, a, b)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m_product</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
</span></span></code></pre></div><pre><code>## [1] 12
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_product</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><pre><code>## [1] 0
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_product</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><pre><code>## a
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_product</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><pre><code>## 2 * a
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">m_product</span>(<span style="color:#a6e22e">quote</span>(a), <span style="color:#a6e22e">quote</span>(b))
</span></span></code></pre></div><pre><code>## a * b
</code></pre>
<p>unary minus</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>is_call <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(x, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">is.recursive</span>(x) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">as.character</span>(x[[1]]) <span style="color:#f92672">==</span> name
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>m_uminus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a)) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span>a
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">length</span>(a) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">identical</span>(a[[1]], <span style="color:#a6e22e">quote</span>(`-`))) {
</span></span><span style="display:flex;"><span>    a[[2]]
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_call</span>(a, <span style="color:#e6db74">&#34;(&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_uminus</span>(a[[2]])
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;-&#34;</span>, a)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>subtraction</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_minus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a, b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">-</span> b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_uminus</span>(b)
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(b) <span style="color:#f92672">&amp;&amp;</span> b <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    a
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;-&#34;</span>, a, b)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and division</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_quotient <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a, b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is.numeric</span>(b)) {
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">/</span> b
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(a) <span style="color:#f92672">&amp;&amp;</span> a <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(b) <span style="color:#f92672">&amp;&amp;</span> b <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Inf</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.numeric</span>(b) <span style="color:#f92672">&amp;&amp;</span> b <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    a
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;/&#34;</span>, a, b)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Finally, parentheses (this is done differently in our implementation but
this is a little simpler):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_parenthesis <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(a) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.symbol</span>(a) <span style="color:#f92672">||</span> <span style="color:#a6e22e">is.numeric</span>(a)) {
</span></span><span style="display:flex;"><span>    a
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#34;(&#34;</span>, a)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can then rewrite all our rules to use these functions instead of
<code>call()</code> directly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>d_plus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">m_plus</span>(<span style="color:#a6e22e">differentiate</span>(expr[[2]], name), <span style="color:#a6e22e">differentiate</span>(expr[[3]], name))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d_minus <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">length</span>(expr) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_uminus</span>(<span style="color:#a6e22e">differentiate</span>(expr[[2]], name))
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m_minus</span>(<span style="color:#a6e22e">differentiate</span>(expr[[2]], name), <span style="color:#a6e22e">differentiate</span>(expr[[3]], name))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d_product <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">&lt;-</span> expr[[2]]
</span></span><span style="display:flex;"><span>  b <span style="color:#f92672">&lt;-</span> expr[[3]]
</span></span><span style="display:flex;"><span>  da <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(a, name)
</span></span><span style="display:flex;"><span>  db <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(b, name)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">m_plus</span>(<span style="color:#a6e22e">m_product</span>(da, b), <span style="color:#a6e22e">m_product</span>(a, db))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d_quotient <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">&lt;-</span> expr[[2]]
</span></span><span style="display:flex;"><span>  b <span style="color:#f92672">&lt;-</span> expr[[3]]
</span></span><span style="display:flex;"><span>  da <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(a, name)
</span></span><span style="display:flex;"><span>  db <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">differentiate</span>(b, name)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## da / b - a * db / (b * b)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">m_minus</span>(<span style="color:#a6e22e">m_quotient</span>(da, b), <span style="color:#a6e22e">m_quotient</span>(<span style="color:#a6e22e">m_product</span>(a, db), <span style="color:#a6e22e">m_product</span>(b, b)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>d_parenthesis <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(expr, name) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">m_parenthesis</span>(<span style="color:#a6e22e">differentiate</span>(expr[[2]], name))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rules <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">list</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;+&#34;</span> <span style="color:#f92672">=</span> d_plus,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">=</span> d_minus,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#f92672">=</span> d_product,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">=</span> d_quotient,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;(&#34;</span> <span style="color:#f92672">=</span> d_parenthesis)
</span></span></code></pre></div><p>Now, when we call <code>differentiate()</code>, things look much nicer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">differentiate</span>(<span style="color:#a6e22e">quote</span>(<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> x <span style="color:#f92672">/</span> (x <span style="color:#f92672">*</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> x)), <span style="color:#e6db74">&#34;x&#34;</span>)
</span></span></code></pre></div><pre><code>## -2/(x * x - 3 * x) - -2 * x * (x + x - 3)/((x * x - 3 * x) * 
##     (x * x - 3 * x))
</code></pre>
<p>There are still some weirdnesses here (e.g., <code>a - -2 * x * (x + x - 3)</code>
which are surprisingly hard to undo; the rhs of this expression is a
tree with structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>lobstr<span style="color:#f92672">::</span><span style="color:#a6e22e">ast</span>(<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> x <span style="color:#f92672">*</span> (x <span style="color:#f92672">+</span> x <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>))
</span></span></code></pre></div><pre><code>## █─`*` 
## ├─█─`*` 
## │ ├─█─`-` 
## │ │ └─2 
## │ └─x 
## └─█─`(` 
##   └─█─`-` 
##     ├─█─`+` 
##     │ ├─x 
##     │ └─x 
##     └─3
</code></pre>
<p>so to simplify subtraction we have to extract the <code>-</code> from within two
layers of multiplication, which is yet more recursion.</p>
<p>Our full implementation can be seen in <a href="https://github.com/mrc-ide/odin/pull/298/files">this pull
request</a>, which follows
the presentation here fairly closely.</p>
<h2 id="why-go-to-this-effort">Why go to this effort?</h2>
<p>Given that the <code>D</code> function (and the
<a href="https://cran.r-project.org/package=Deriv"><code>Deriv</code></a> package) can do all
this (and more) already, it’s not very obvious why you might want to
this. We don’t really want to differentiate R, but instead the domain
specific language that supports odin. This is a <a href="https://mrc-ide.github.io/odin/articles/functions.html">small subset of
R</a> but there are
two things that have quite different semantics that we need considerable
control over (they’re not yet supported in the PR linked above).</p>
<p>Firstly, odin (via <a href="https://mrc-ide.github.io/odin.dust/">odin.dust</a>)
supports converting stochastic models into deterministic ones by taking
expectations of the stochastic components; the underlying stochastic
support already looks different to the call expected from R. So for
example, we might write:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbinom</span>(n, p)
</span></span></code></pre></div><p>to represent a binomial random draw with size <code>n</code> and probability <code>p</code>;
R’s first argument (the number of draws to take) does not appear here.
The expectation of this draw is simply <code>n * p</code> and we can now easily add
rules to our differentiation support to differentiate this part of a
model with respect to any other model quantity.</p>
<p>The other tricky part we have is the way that odin interprets array
expressions, especially those that contain sums, as these have specific
semantics. For example, the valid odin expression</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>lambda[] <span style="color:#f92672">&lt;-</span> beta <span style="color:#f92672">*</span> <span style="color:#a6e22e">sum</span>(s_ij[, i])
</span></span></code></pre></div><p>could be rewritten as in something more R-ish</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (i <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">seq_along</span>(lambda)) {
</span></span><span style="display:flex;"><span>  lambda[i] <span style="color:#f92672">&lt;-</span> beta <span style="color:#f92672">*</span> <span style="color:#a6e22e">sum</span>(s_ij[, i])
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and differentiating the odin DSL version requires knowledge of these
semantics. The solution to this is left as an exercise to the reader,
and possibly a future blog post…</p>


            </div>
            
            <br>
            <div class="share">
                
                <a href="" class="ssk ssk-facebook"></a>
                
                
                <a href="" class="ssk ssk-twitter"></a>
                
                
                
                <a href="" class="ssk ssk-linkedin"></a>
                
            </div>
            
            
            <br>
            <div class="navigation">
                
                <div>
                    <img class="icon" src="https://reside-ic.github.io/img/back.svg" alt="back" />
                    <a href="https://reside-ic.github.io/blog/conditionally-running-ingest-pipelines-with-filebeat-docker-and-elastic/">Conditionally running Ingest Pipelines with Filebeat, Docker and Elastic</a>
                </div>
                
                <div style="width: 100%;"></div>
                
                <div>
                    <a href="https://reside-ic.github.io/blog/mpi-from-r-part-one-the-basics/">MPI from R - Part One - The Basics</a>
                    <img class="icon" src="https://reside-ic.github.io/img/next.svg" alt="next" />
                </div>
                
            </div>
            
            
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "reside-ic" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            

            

            
        </div>
    </div>
</div>



<div class="footer column">
    <div class="container">

        

        <div class="copyright">

        
            
                <a href="https://reside-ic.github.io/license">Copyright © 2024 Reside-IC</a>
            
        

        </div>
        <div class="icons">

        

        

        

        

        

        
            <a href="https://github.com/reside-ic" rel=me target="_blank">
                <img class="icon" src="https://reside-ic.github.io/img/github.svg" alt="github" />
            </a>
        

        

        

        

        

        
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Raleway:400,600,700', 'Merriweather:300,300i,700,700i', 'Ubuntu+Mono:400,700']
    }
  });
</script>



  <script src="https://reside-ic.github.io/js/highlight.min.js" defer></script>
  



  <script src="https://reside-ic.github.io/js/progressively.min.js" defer></script>



  <script src="https://reside-ic.github.io/js/social-share-kit.min.js" defer></script>





  
  
    
      
    
  




<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
    
      SocialShareKit.init({
        twitter: {
            text: '',
            
        }
      });
    
  };
</script>




</body>
</html>

